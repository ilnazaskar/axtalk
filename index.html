<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>AxTalk</title>
<meta name="theme-color" content="#0c0f14" />
<style>
:root{
  --bg:#0c0f14;
  --bg-2:#0f131a;
  --outline:#1c2230;
  --text:#e8ecf8;
  --text-dim:#9aa7c8;
  --green:#1bd35f;
  --red:#ff3b30;
  --ring:0 0 0 3px #2c5bff33;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
.app{min-height:100svh;display:grid}
.shell{max-width:520px;margin:auto;min-height:100svh;height:100%;display:grid;background:var(--bg);}
.screen{display:none} .screen.active{display:block}

/* generic */
.pad{padding:18px}
.stack{display:flex;flex-direction:column;gap:12px}
.row{display:flex;gap:10px;align-items:center}
.btn{
  all:unset;cursor:pointer;border:1px solid var(--outline);border-radius:14px;
  background:var(--bg-2);padding:12px 14px;display:flex;justify-content:center;align-items:center
}
.btn.primary{background:#27406f;color:#fff;border-color:#27406f}
.btn:focus-visible{box-shadow:var(--ring)}
.iconbtn{
  all:unset;cursor:pointer;border:1px solid var(--outline);border-radius:10px;
  background:var(--bg-2);width:36px;height:36px;display:grid;place-items:center
}
.iconbtn:focus-visible{box-shadow:var(--ring)}
.card{border:1px solid var(--outline);border-radius:16px;background:var(--bg-2);padding:14px}
.hr{height:1px;background:var(--outline);margin:8px 0}
.note{color:var(--text-dim);font-size:12.5px}

/* auth */
.hero{display:grid;gap:16px;padding:28px}
.hero .title{font-size:22px;font-weight:700}
.google{display:flex;gap:10px;align-items:center;justify-content:center}
.google svg{background:#fff;border-radius:50%;display:block}

/* friends */
.friend{
  display:flex;align-items:center;justify-content:space-between;
  padding:10px;border-radius:12px;border:1px solid var(--outline);gap:10px
}
.friend .who{display:flex;gap:12px;align-items:center;min-width:0}
.ava{width:36px;height:36px;border-radius:50%;display:grid;place-items:center;background:#1b2130;border:1px solid var(--outline);position:relative;flex:0 0 auto}
.dot{position:absolute;right:-2px;bottom:-2px;width:10px;height:10px;border-radius:99px;background:#586174;border:1px solid var(--bg-2)}
.dot.on{background:#1bd35f}
.friend .titleline{display:flex;flex-direction:column;min-width:0}
.friend .titleline b{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:60vw}

/* modals */
.modal{position:fixed;inset:0;background:#0008;display:none;place-items:center;padding:18px;z-index:20}
.modal.show{display:grid}
.sheet{width:100%;max-width:420px;background:var(--bg-2);border:1px solid var(--outline);border-radius:18px;padding:18px;display:grid;gap:12px}
.actions{display:flex;gap:12px;justify-content:center}
.act{all:unset;cursor:pointer;min-width:120px;height:44px;border-radius:12px;display:grid;place-items:center;color:#fff}
.act.accept{background:var(--green)} .act.decline{background:var(--red)}

/* call screen */
.call{min-height:100svh;display:grid;grid-template-rows:auto 1fr auto}
.topbar{display:flex;align-items:center;justify-content:flex-end;padding:10px 14px;border-bottom:1px solid var(--outline)}
.invite-btn{all:unset;border:1px solid var(--outline);border-radius:12px;padding:8px 12px;cursor:pointer}

.peers{display:flex;gap:12px;align-items:center;overflow:auto;padding:10px 14px;border-bottom:1px solid var(--outline);-webkit-overflow-scrolling:touch}
.peer{
  position:relative;min-width:52px;width:52px;height:52px;border-radius:50%;display:grid;place-items:center;
  font-weight:600;letter-spacing:.2px;
  background:#1b2130;border:2px solid #1b2130; color:#fff;cursor:pointer;user-select:none;flex:0 0 auto
}
.peer .vad{position:absolute;inset:-3px;border-radius:50%;border:3px solid transparent;pointer-events:none}
.peer .vad.on{border-color:#1bd35f}

.center{display:grid;place-items:center;padding:18px}
.timer{font-size: clamp(36px, 9vw, 56px);font-weight:800;letter-spacing:.5px;text-align:center}

.controls{display:flex;gap:22px;justify-content:center;align-items:center;padding:16px;border-top:1px solid var(--outline)}
.fab{all:unset;width:68px;height:68px;border-radius:50%;display:grid;place-items:center;color:#fff;cursor:pointer;box-shadow:0 8px 22px #0006;border:1px solid #0000}
.fab.mic.on{background:var(--green)}
.fab.mic.off{background:#3a4354}
.fab.end{background:var(--red)}

.smallmenu{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);min-width:260px;background:var(--bg-2);border:1px solid var(--outline);border-radius:14px;padding:14px;display:none}
.smallmenu.show{display:block}
.smallmenu .row{justify-content:space-between}
.range{width:160px}
audio{display:none}

/* responsive */
@media (max-width: 520px){
  .shell{max-width:100%}
  .friend{flex-direction:column;align-items:stretch}
  .friend .row{justify-content:flex-end}
  .friend .titleline b{max-width:100%}
  .controls{gap:14px}
  .fab{width:60px;height:60px}
}
input[type="text"]{color:var(--text);background:var(--bg-2);border:1px solid var(--outline);padding:10px 12px;border-radius:12px;width:100%}
</style>
</head>
<body>
<div class="app">
  <div class="shell" id="app">

    <!-- AUTH -->
    <section class="screen" id="screen-auth">
      <div class="hero">
        <div class="title">AxTalk</div>
        <button id="btn-google" class="btn primary google">
          <svg width="18" height="18" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.303C33.245,32.091,29.065,35,24,35c-6.075,0-11-4.925-11-11 s4.925-11,11-11c2.803,0,5.367,1.059,7.314,2.786l5.657-5.657C33.555,6.053,28.973,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"/><path fill="#FF3D00" d="M6.306,14.691l6.571,4.819C14.655,16.108,18.961,13,24,13c2.803,0,5.367,1.059,7.314,2.786l5.657-5.657 C33.555,6.053,28.973,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"/><path fill="#4CAF50" d="M24,44c4.942,0,9.448-1.897,12.837-4.993l-5.926-5.018C29.006,35.091,26.668,36,24,36 c-5.041,0-9.21-2.899-11.281-7.074l-6.522,5.025C9.505,39.556,16.227,44,24,44z"/><path fill="#1976D2" d="M43.611,20.083H42В20H24v8h11.303c-1.018,2.908-3.168,5.266-5.89,6.724 c0.001-0.001,0.002-0.001,0.003-0.002l5.926,5.018C34.971,40.149,44,34,44,24C44,22.659,43.862,21.35,43.611,20.083z"/></svg>
          Войти через Google
        </button>
      </div>
    </section>

    <!-- FRIENDS -->
    <section class="screen" id="screen-friends">
      <div class="pad stack">

        <div class="row" style="justify-content:space-between">
          <div class="row" style="gap:8px">
            <div id="meBadge" class="badge">…</div>
            <button id="btn-edit-name" class="iconbtn" title="Изменить ник" aria-label="Изменить ник">✎</button>
          </div>
          <button id="btn-signout" class="btn">Выйти</button>
        </div>

        <div class="card" id="profile-card">
          <div class="row" style="justify-content:space-between">
            <div class="note" style="text-align:left">Ваш ID: <code id="meUid">…</code></div>
            <button id="btn-copy-uid" class="iconbtn" title="Скопировать ID" aria-label="Скопировать ID">⧉</button>
          </div>
        </div>

        <div class="card">
          <div class="row" style="justify-content:space-between"><b>Друзья</b><button id="btn-add-friend" class="btn">Добавить друга</button></div>
          <div id="friends" class="stack"></div>
        </div>

      </div>
    </section>

    <!-- CALL -->
    <section class="screen" id="screen-call">
      <div class="call">
        <div class="topbar">
          <button id="btn-invite" class="invite-btn">Пригласить друга</button>
        </div>

        <div class="peers" id="peers"></div>

        <div class="center"><div id="timer" class="timer">0:00:00</div></div>

        <div class="controls">
          <button id="btn-mic" class="fab mic on" title="Микрофон">
            <svg width="30" height="30" viewBox="0 0 24 24" fill="none"><path d="M12 14a3 3 0 0 0 3-3V6a3 3 0 1 0-6 0v5a3 3 0 0 0 3 3Zm7-3a1 1 0 1 1 2 0 9 9 0 0 1-8 8.94V22a1 1 0 0 1-2 0v-2.06A9 9 0 0 1 5 11a1 1 0 1 1 2 0 7 7 0 1 0 14 0Z" fill="currentColor"/></svg>
          </button>
          <button id="btn-end" class="fab end" title="Завершить">
            <svg width="30" height="30" viewBox="0 0 24 24" fill="currentColor"><path d="M12 8c2.76 0 5.26 1.12 7.07 2.93l.93.93a1 1 0 0 1 0 1.41l-2 2a1 1 0 0 1-1.41 0l-1.06-1.06a1 1 0 0 0-1.1-.22 7.6 7.6 0 0 1-4.86 0 1 1 0 0 0-1.1.22L7.41 15.3a1 1 0 0 1-1.41 0l-2-2a1 1 0 0 1 0-1.41l.93-.93A11 11 0 0 1 12 8Z"/></svg>
          </button>
        </div>
      </div>
    </section>

    <!-- INCOMING CALL -->
    <div id="incoming" class="modal">
      <div class="sheet">
        <div style="font-weight:700;text-align:center">Входящий звонок</div>
        <div id="inc-from" class="note" style="text-align:center"></div>
        <div class="actions">
          <button id="inc-accept" class="act accept" title="Принять">Принять</button>
          <button id="inc-decline" class="act decline" title="Отклонить">Отклонить</button>
        </div>
      </div>
    </div>

    <!-- OUTGOING (dialing) -->
    <div id="calling" class="modal">
      <div class="sheet">
        <div id="calling-title" style="font-weight:700;text-align:center">Звоним…</div>
        <div class="actions">
          <button id="calling-cancel" class="act decline">Отменить</button>
        </div>
      </div>
    </div>

    <!-- ADD FRIEND -->
    <div id="addfriend" class="modal">
      <div class="sheet">
        <div style="font-weight:700">Добавить друга</div>
        <div class="note">Введите 8-значный ID</div>
        <input id="af-id" inputmode="numeric" pattern="[0-9]*" maxlength="8"
               type="text" placeholder="Напр. 02831459"
               style="all:unset;background:var(--bg-2);border:1px solid var(--outline);padding:10px 12px;border-radius:12px;width:100%"/>
        <div class="actions">
          <button id="af-add" class="act accept">Добавить</button>
          <button id="af-cancel" class="act decline">Отмена</button>
        </div>
      </div>
    </div>

    <!-- EDIT MY NAME -->
    <div id="editname" class="modal">
      <div class="sheet">
        <div style="font-weight:700">Изменить ник</div>
        <input id="en-input" type="text" placeholder="Ваш ник"
               style="all:unset;background:var(--bg-2);border:1px solid var(--outline);padding:10px 12px;border-radius:12px;width:100%"/>
        <div class="actions">
          <button id="en-save" class="act accept">Сохранить</button>
          <button id="en-cancel" class="act decline">Отмена</button>
        </div>
      </div>
    </div>

    <!-- FRIEND MENU -->
    <div id="friend-menu" class="smallmenu">
      <div class="row" style="justify-content:space-between"><b id="fm-name">Ник</b><button id="fm-close" class="btn">✕</button></div>
      <div class="hr"></div>
      <div class="row" style="justify-content:space-between">
        <span class="note">Пометка</span>
        <input id="fm-note" class="range" type="text" placeholder="например: Никита" style="width:180px"/>
      </div>
      <div class="row" style="justify-content:flex-end;gap:8px">
        <button id="fm-save" class="btn primary">Сохранить</button>
        <button id="fm-delete" class="btn" style="border-color:#822;color:#fff;background:#2a1111">Удалить из друзей</button>
      </div>
    </div>

    <!-- INVITE FRIENDS (внутри звонка) -->
    <div id="invite-list" class="modal">
      <div class="sheet">
        <div style="font-weight:700">Пригласить друга</div>
        <div id="invite-container" class="stack"></div>
        <div class="actions"><button id="invite-close" class="act decline">Закрыть</button></div>
      </div>
    </div>

    <!-- hidden audio sinks -->
    <div id="audio-sinks"></div>
  </div>
</div>

<script type="module">
/* ===== Firebase ===== */
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js';
import {
  getAuth, GoogleAuthProvider, signInWithPopup, signInWithRedirect,
  onAuthStateChanged, signOut
} from 'https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js';
import {
  getFirestore, doc, setDoc, getDoc, addDoc, getDocs, updateDoc, deleteDoc,
  collection, serverTimestamp, onSnapshot, query, where, limit
} from 'https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js';

const firebaseConfig = {
  apiKey: "AIzaSyCezq2wfC4p2ucVz5wzreoaxBTzvHjkwzg",
  authDomain: "call-19b9a.firebaseapp.com",
  projectId: "call-19b9a",
  storageBucket: "call-19b9a.firebasestorage.app",
  messagingSenderId: "264482012809",
  appId: "1:264482012809:web:d0a30eabbd3184944a5058",
  measurementId: "G-TDP7N49324"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db   = getFirestore(app);

/* ===== helpers ===== */
const $  = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
const show = id => { $$('.screen').forEach(x=>x.classList.remove('active')); $(id).classList.add('active'); };
function initials(name){ return (name||'?').trim().slice(0,1).toUpperCase(); }
function sec2hms(sec){ const h=Math.floor(sec/3600)|0; const m=Math.floor((sec%3600)/60)|0; const s=(sec%60)|0; return `${h}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`; }
const onlyDigits = s => (s||'').replace(/\D/g,'');

/* ===== incoming call rejection (закрытие окна) ===== */
$('#inc-decline').onclick = async ()=> {
  // Закрытие звонка для человека А, если Б отклоняет звонок
  try{ if(createdInviteRef) await updateDoc(createdInviteRef, { status:'declined' }); }catch(e){}
  try{ if(createdCallRef) await deleteDoc(createdCallRef); }catch(e){}
  $('#calling').classList.remove('show');
  createdCallRef=null; createdInviteRef=null;
};
</script>
</body>
</html>
