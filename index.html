<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>AxTalk</title>
<meta name="theme-color" content="#0c0f14" />
<style>
:root{
  --bg:#0c0f14;
  --bg-2:#0f131a;
  --outline:#1c2230;
  --text:#e8ecf8;
  --text-dim:#9aa7c8;
  --green:#1bd35f;
  --red:#ff3b30;
  --ring:0 0 0 3px #2c5bff33;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sанс-serif}
.app{min-height:100svh;display:grid}
.shell{max-width:520px;margin:auto;min-height:100svh;height:100%;display:grid;background:var(--bg);}
.screen{display:none} .screen.active{display:block}

/* generic */
.pad{padding:18px}
.stack{display:flex;flex-direction:column;gap:12px}
.row{display:flex;gap:10px;align-items:center}
.btn{
  all:unset;cursor:pointer;border:1px solid var(--outline);border-radius:14px;
  background:var(--bg-2);padding:12px 14px;display:flex;justify-content:center;align-items:center
}
.btn.primary{background:#27406f;color:#fff;border-color:#27406f}
.btn:focus-visible{box-shadow:var(--ring)}
.input{
  all:unset;box-sizing:border-box;width:100%;
  background:var(--bg-2);border:1px solid var(--outline);border-radius:12px;
  padding:10px 12px;color:var(--text);caret-color:var(--text)
}
.input:focus-visible{box-shadow:var(--ring);border-color:#2c5bff}
.input::placeholder{color:var(--text-dim);opacity:1}
/* special case: friend note input by id */
#fm-note{
  all:unset;box-sizing:border-box;background:var(--bg-2);
  border:1px solid var(--outline);border-radius:12px;
  padding:10px 12px;color:var(--text);caret-color:var(--text)
}
#fm-note:focus-visible{box-shadow:var(--ring);border-color:#2c5bff}
#fm-note::placeholder{color:var(--text-dim);opacity:1}
.iconbtn{
  all:unset;cursor:pointer;border:1px solid var(--outline);border-radius:10px;
  background:var(--bg-2);width:36px;height:36px;display:grid;place-items:center
}
.iconbtn:focus-visible{box-shadow:var(--ring)}
.card{border:1px solid var(--outline);border-radius:16px;background:var(--bg-2);padding:14px}
.hr{height:1px;background:var(--outline);margin:8px 0}
.note{color:var(--text-dim);font-size:12.5px}

/* auth */
.hero{display:grid;gap:16px;padding:28px}
.hero .title{font-size:22px;font-weight:700}
.google{display:flex;gap:10px;align-items:center;justify-content:center}
.google svg{background:#fff;border-radius:50%;display:block}

/* friends */
.friend{
  display:flex;align-items:center;justify-content:space-between;
  padding:10px;border-radius:12px;border:1px solid var(--outline);gap:10px
}
.friend .who{display:flex;gap:12px;align-items:center;min-width:0}
.ava{width:36px;height:36px;border-radius:50%;display:grid;place-items:center;background:#1b2130;border:1px solid var(--outline);position:relative;flex:0 0 auto}
.dot{position:absolute;right:-2px;bottom:-2px;width:10px;height:10px;border-radius:99px;background:#586174;border:1px solid var(--bg-2)}
.dot.on{background:#1bd35f}
.friend .titleline{display:flex;flex-direction:column;min-width:0}
.friend .titleline b{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:60vw}

/* modals */
.modal{position:fixed;inset:0;background:#0008;display:none;place-items:center;padding:18px;z-index:20}
.modal.show{display:grid}
.sheet{width:100%;max-width:420px;background:var(--bg-2);border:1px solid var(--outline);border-radius:18px;padding:18px;display:grid;gap:12px}
.actions{display:flex;gap:12px;justify-content:center}
.act{all:unset;cursor:pointer;min-width:120px;height:44px;border-radius:12px;display:grid;place-items:center;color:#fff}
.act.accept{background:var(--green)} .act.decline{background:var(--red)}

/* call screen — как на макете */
.call{min-height:100svh;display:grid;grid-template-rows:auto 1fr auto}
.topbar{display:flex;align-items:center;justify-content:flex-end;padding:10px 14px;border-bottom:1px solid var(--outline)}
.invite-btn{all:unset;border:1px solid var(--outline);border-radius:12px;padding:8px 12px;cursor:pointer}

.peers{display:flex;gap:12px;align-items:center;overflow:auto;padding:10px 14px;border-bottom:1px solid var(--outline);-webkit-overflow-scrolling:touch}
.peer{
  position:relative;min-width:52px;width:52px;height:52px;border-radius:50%;display:grid;place-items:center;
  font-weight:600;letter-spacing:.2px;
  background:#1b2130;border:2px solid #1b2130; color:#fff;cursor:pointer;user-select:none;flex:0 0 auto
}
.peer .vad{position:absolute;inset:-3px;border-radius:50%;border:3px solid transparent;pointer-events:none}
.peer .vad.on{border-color:#1bd35f}

.center{display:grid;place-items:center;padding:18px}
.timer{font-size: clamp(36px, 9vw, 56px);font-weight:800;letter-spacing:.5px;text-align:center}

.controls{display:flex;gap:22px;justify-content:center;align-items:center;padding:16px;border-top:1px solid var(--outline)}
.fab{all:unset;width:68px;height:68px;border-radius:50%;display:grid;place-items:center;color:#fff;cursor:pointer;box-shadow:0 8px 22px #0006;border:1px solid #0000}
.fab.mic.on{background:var(--green)}
.fab.mic.off{background:#3a4354}
.fab.end{background:var(--red)}

.smallmenu{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);min-width:260px;background:var(--bg-2);border:1px solid var(--outline);border-radius:14px;padding:14px;display:none}
.smallmenu.show{display:block}
.smallmenu .row{justify-content:space-between}
.range{width:160px}
audio{display:none}

/* responsive */
@media (max-width: 520px){
  .shell{max-width:100%}
  .friend{flex-direction:column;align-items:stretch}
  .friend .row{justify-content:flex-end}
  .friend .titleline b{max-width:100%}
  .controls{gap:14px}
  .fab{width:60px;height:60px}
}
input[type="text"]{color:var(--text)}
</style>
</head>
<body>
<div class="app">
  <div class="shell" id="app">

    <!-- AUTH -->
    <section class="screen" id="screen-auth">
      <div class="hero">
        <div class="title">AxTalk</div>
        <button id="btn-google" class="btn primary google">
          <svg width="18" height="18" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.303C33.245,32.091,29.065,35,24,35c-6.075,0-11-4.925-11-11 s4.925-11,11-11c2.803,0,5.367,1.059,7.314,2.786l5.657-5.657C33.555,6.053,28.973,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"/><path fill="#FF3D00" d="M6.306,14.691l6.571,4.819C14.655,16.108,18.961,13,24,13c2.803,0,5.367,1.059,7.314,2.786l5.657-5.657 C33.555,6.053,28.973,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"/><path fill="#4CAF50" d="M24,44c4.942,0,9.448-1.897,12.837-4.993l-5.926-5.018C29.006,35.091,26.668,36,24,36 c-5.041,0-9.21-2.899-11.281-7.074l-6.522,5.025C9.505,39.556,16.227,44,24,44z"/><path fill="#1976D2" d="M43.611,20.083H42В20H24v8h11.303c-1.018,2.908-3.168,5.266-5.89,6.724 c0.001-0.001,0.002-0.001,0.003-0.002l-5.926,5.018C34.971,40.149,44,34,44,24C44,22.659,43.862,21.35,43.611,20.083z"/></svg>
          Войти через Google
        </button>
      </div>
    </section>

    <!-- FRIENDS -->
    <section class="screen" id="screen-friends">
      <div class="pad stack">

        <div class="row" style="justify-content:space-between">
          <div class="row" style="gap:8px">
            <div id="meBadge" class="badge">…</div>
            <button id="btn-edit-name" class="iconbtn" title="Изменить ник" aria-label="Изменить ник">✎</button>
          </div>
          <button id="btn-signout" class="btn">Выйти</button>
        </div>

        <div class="card" id="profile-card">
          <div class="row" style="justify-content:space-between">
            <div class="note" style="text-align:left">Ваш ID: <code id="meUid">…</code></div>
            <button id="btn-copy-uid" class="iconbtn" title="Скопировать ID" aria-label="Скопировать ID">⧉</button>
          </div>
        </div>

        <div class="card">
          <div class="row" style="justify-content:space-between"><b>Друзья</b><button id="btn-add-friend" class="btn">Добавить друга</button></div>
          <div id="friends" class="stack"></div>
        </div>

      </div>
    </section>

    <!-- CALL -->
    <section class="screen" id="screen-call">
      <div class="call">
        <div class="topbar">
          <button id="btn-invite" class="invite-btn">Пригласить друга</button>
        </div>

        <div class="peers" id="peers"></div>

        <div class="center"><div id="timer" class="timer">0:00:00</div></div>

        <div class="controls">
          <button id="btn-mic" class="fab mic on" title="Микрофон">
            <svg width="30" height="30" viewBox="0 0 24 24" fill="none"><path d="M12 14a3 3 0 0 0 3-3V6a3 3 0 1 0-6 0v5a3 3 0 0 0 3 3Zm7-3a1 1 0 1 1 2 0 9 9 0 0 1-8 8.94V22a1 1 0 0 1-2 0v-2.06A9 9 0 0 1 5 11a1 1 0 1 1 2 0 7 7 0 1 0 14 0Z" fill="currentColor"/></svg>
          </button>
          <button id="btn-end" class="fab end" title="Завершить">
            <svg width="30" height="30" viewBox="0 0 24 24" fill="currentColor"><path d="M12 8c2.76 0 5.26 1.12 7.07 2.93l.93.93a1 1 0 0 1 0 1.41l-2 2a1 1 0 0 1-1.41 0l-1.06-1.06a1 1 0 0 0-1.1-.22 7.6 7.6 0 0 1-4.86 0 1 1 0 0 0-1.1.22L7.41 15.3a1 1 0 0 1-1.41 0l-2-2a1 1 0 0 1 0-1.41l.93-.93A11 11 0 0 1 12 8Z"/></svg>
          </button>
        </div>
      </div>
    </section>

    <!-- INCOMING CALL -->
    <div id="incoming" class="modal">
      <div class="sheet">
        <div style="font-weight:700;text-align:center">Входящий звонок</div>
        <div id="inc-from" class="note" style="text-align:center"></div>
        <div class="actions">
          <button id="inc-accept" class="act accept" title="Принять">Принять</button>
          <button id="inc-decline" class="act decline" title="Отклонить">Отклонить</button>
        </div>
      </div>
    </div>

    <!-- OUTGOING (dialing) -->
    <div id="calling" class="modal">
      <div class="sheet">
        <div id="calling-title" style="font-weight:700;text-align:center">Звоним…</div>
        <div class="actions">
          <button id="calling-cancel" class="act decline">Отменить</button>
        </div>
      </div>
    </div>

    <!-- ADD FRIEND -->
    <div id="addfriend" class="modal">
      <div class="sheet">
        <div style="font-weight:700">Добавить друга</div>
        <div class="note">Введите 8-значный ID</div>
        <input id="af-id" inputmode="numeric" pattern="[0-9]*" maxlength="8"
               type="text" placeholder="Напр. 02831459"
               class="input"/>
        <div class="actions">
          <button id="af-add" class="act accept">Добавить</button>
          <button id="af-cancel" class="act decline">Отмена</button>
        </div>
      </div>
    </div>

    <!-- EDIT MY NAME -->
    <div id="editname" class="modal">
      <div class="sheet">
        <div style="font-weight:700">Изменить ник</div>
        <input id="en-input" type="text" placeholder="Ваш ник"
               class="input"/>
        <div class="actions">
          <button id="en-save" class="act accept">Сохранить</button>
          <button id="en-cancel" class="act decline">Отмена</button>
        </div>
      </div>
    </div>

    <!-- FRIEND MENU -->
    <div id="friend-menu" class="smallmenu">
      <div class="row" style="justify-content:space-between"><b id="fm-name">Ник</b><button id="fm-close" class="btn">✕</button></div>
      <div class="hr"></div>
      <div class="row" style="justify-content:space-between">
        <span class="note">Пометка</span>
        <input id="fm-note" class="range" type="text" placeholder="например: Никита" style="width:180px"/>
      </div>
      <div class="row" style="justify-content:flex-end;gap:8px">
        <button id="fm-save" class="btn primary">Сохранить</button>
        <button id="fm-delete" class="btn" style="border-color:#822;color:#fff;background:#2a1111">Удалить из друзей</button>
      </div>
    </div>
    <!-- PEER MENU (in-call) -->
    <div id="peer-menu" class="smallmenu">
      <div class="row" style="justify-content:space-between"><b id="pm-name"></b><button id="pm-close" class="btn">×</button></div>
      <div class="hr"></div>
      <div class="row" style="justify-content:space-between">
        <span class="note">Громкость</span>
        <input id="pm-volume" class="range" type="range" min="0" max="200" value="100"/>
      </div>
    </div>

    <!-- INVITE FRIENDS (внутри звонка) -->
    <div id="invite-list" class="modal">
      <div class="sheet">
        <div style="font-weight:700">Пригласить друга</div>
        <div id="invite-container" class="stack"></div>
        <div class="actions"><button id="invite-close" class="act decline">Закрыть</button></div>
      </div>
    </div>

    <!-- hidden audio sinks -->
    <div id="audio-sinks"></div>
  </div>
</div>

<script type="module">
/* ===== Firebase ===== */
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js';
import {
  getAuth, GoogleAuthProvider, signInWithPopup, signInWithRedirect,
  onAuthStateChanged, signOut
} from 'https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js';
import {
  getFirestore, doc, setDoc, getDoc, addDoc, getDocs, updateDoc, deleteDoc,
  collection, serverTimestamp, onSnapshot, query, where, limit, deleteField /* << добавлено deleteField */
} from 'https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js';

const firebaseConfig = {
  apiKey: "AIzaSyCezq2wfC4p2ucVz5wzreoaxBTzvHjkwzg",
  authDomain: "call-19b9a.firebaseapp.com",
  projectId: "call-19b9a",
  storageBucket: "call-19b9a.firebasestorage.app",
  messagingSenderId: "264482012809",
  appId: "1:264482012809:web:d0a30eabbd3184944a5058",
  measurementId: "G-TDP7N49324"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db   = getFirestore(app);

/* ===== helpers ===== */
const $  = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
const show = id => { $$('.screen').forEach(x=>x.classList.remove('active')); $(id).classList.add('active'); };
function initials(name){ return (name||'?').trim().slice(0,1).toUpperCase(); }
function sec2hms(sec){ const h=Math.floor(sec/3600)|0; const m=Math.floor((sec%3600)/60)|0; const s=(sec%60)|0; return `${h}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`; }
const onlyDigits = s => (s||'').replace(/\D/g,'');
const GOOD = '1';

/* ===== keep screen on refresh ===== */
(function preloadScreen(){
  if(localStorage.getItem('ax_logged')===GOOD) show('#screen-friends');
  else show('#screen-auth');
})();

/* ===== presence ===== */
let presTimer=null;
async function setPresence(user){
  const uref=doc(db,'users',user.uid);
  await setDoc(uref,{ uid:user.uid, name:user.displayName||'Без имени', email:user.email||null, lastActive:serverTimestamp(), online:true }, {merge:true});
  clearInterval(presTimer);
  presTimer=setInterval(()=> updateDoc(uref,{ lastActive:serverTimestamp(), online:true }).catch(()=>{}), 20000);
}

/* ===== 8-значный friendCode ===== */
async function ensureFriendCode(uid){
  const uref = doc(db,'users',uid);
  const snap = await getDoc(uref);
  let data = snap.data() || {};
  if (data.friendCode && /^\d{8}$/.test(data.friendCode)) return data.friendCode;

  const gen = ()=> String(Math.floor(Math.random()*1e8)).padStart(8,'0');
  let code = gen();
  for (let i=0;i<6;i++){
    const q = query(collection(db,'users'), where('friendCode','==', code), limit(1));
    const r = await getDocs(q);
    if (r.empty) break;
    code = gen();
  }
  await setDoc(uref, { friendCode: code }, { merge:true });
  return code;
}

/* ===== auth ===== */
const provider = new GoogleAuthProvider();
provider.setCustomParameters({ prompt: 'select_account' });

$('#btn-google').onclick = async ()=>{
  try { await signInWithPopup(auth, provider); }
  catch (e) {
    if (e.code === 'auth/popup-blocked' || e.code === 'auth/popup-closed-by-user') {
      try { await signInWithRedirect(auth, provider); } catch (er) { alert('Ошибка входа: '+er.code); }
    } else if (e.code === 'auth/unauthorized-domain') {
      alert('Добавь домен в Firebase → Auth → Settings → Authorized domains → ' + location.hostname);
    } else if (e.code === 'auth/operation-not-supported-in-this-environment') {
      alert('Открой сайт через http(s):// (не file://)');
    } else { alert('Ошибка: '+e.code); }
  }
};
$('#btn-signout').onclick = ()=>{ try{clearInterval(presTimer);}catch{}; localStorage.removeItem('ax_logged'); signOut(auth); };

onAuthStateChanged(auth, async (user)=>{
  if(!user){ show('#screen-auth'); return; }
  localStorage.setItem('ax_logged', GOOD);
  await setPresence(user);
  const code = await ensureFriendCode(user.uid);
  const usnap = await getDoc(doc(db,'users',user.uid));
  const name  = (usnap.data()||{}).name || user.displayName || 'Без имени';
  $('#meBadge').textContent = name;
  $('#meUid').textContent = code;
  await loadFriends();
  listenIncoming();
  show('#screen-friends');
});

/* ===== edit my name ===== */
$('#btn-edit-name').onclick = async ()=>{
  const usnap = await getDoc(doc(db,'users',auth.currentUser.uid));
  $('#en-input').value = (usnap.data()||{}).name || auth.currentUser.displayName || '';
  $('#editname').classList.add('show');
};
$('#en-cancel').onclick = ()=> $('#editname').classList.remove('show');
$('#en-save').onclick = async ()=>{
  const name = $('#en-input').value.trim() || 'Без имени';
  await setDoc(doc(db,'users',auth.currentUser.uid), { name }, {merge:true});
  $('#meBadge').textContent = name;
  $('#editname').classList.remove('show');
  await loadFriends();
};

/* copy code */
$('#btn-copy-uid').onclick = async ()=>{
  try{ await navigator.clipboard.writeText($('#meUid').textContent.trim()); $('#btn-copy-uid').textContent='✓'; setTimeout(()=>$('#btn-copy-uid').textContent='⧉',1000);}catch{}
};

/* ===== friends list ===== */
async function loadFriends(){
  const list=$('#friends'); list.innerHTML='';
  const fs = await getDocs(collection(db,'users',auth.currentUser.uid,'friends'));
  if(fs.empty){ list.innerHTML = '<div class="note" style="text-align:center">Список пуст. Нажмите «Добавить друга».</div>'; return; }
  fs.forEach(snap=>{
    const fr = snap.data();
    const el=document.createElement('div');
    el.className='friend';
    const label = `${fr.name || 'Без имени'}${fr.note ? ' ~ ' + fr.note : ''}`;
    el.innerHTML=`
      <div class="who">
        <div class="ava"><span>${initials(fr.name||'')}</span><span class="dot ${fr.online?'on':''}"></span></div>
        <div class="titleline">
          <b title="${label}">${label}</b>
          <div class="note">ID: ${fr.friendCode || fr.code || '—'}</div>
        </div>
      </div>
      <div class="row">
        <button class="btn primary" data-call="${fr.uid}">Позвонить</button>
        <button class="btn" data-edit="${fr.uid}">✎</button>
      </div>`;
    el.querySelector('[data-call]').onclick = ()=> placeCall(fr.uid, fr.name||'Без имени');
    el.querySelector('[data-edit]').onclick = ()=> openFriendMenu(fr.uid, fr.name||'Без имени', fr.note||'');
    list.appendChild(el);
  });
}

/* добавить друга (взаимно) */
$('#btn-add-friend').onclick = ()=>{ $('#af-id').value=''; $('#addfriend').classList.add('show'); };
$('#af-cancel').onclick = ()=> $('#addfriend').classList.remove('show');
$('#af-add').onclick = async ()=>{
  const code = onlyDigits($('#af-id').value).padStart(8,'0');
  if(!/^\d{8}$/.test(code)) return;
  const q = query(collection(db,'users'), where('friendCode','==', code), limit(1));
  const res = await getDocs(q);
  if(res.empty) return;
  const target = res.docs[0].data();
  const targetUid = target.uid;
  if(targetUid === auth.currentUser.uid) return;

  const mySnap = await getDoc(doc(db,'users',auth.currentUser.uid));
  const me = mySnap.data()||{};

  await setDoc(doc(db,'users',auth.currentUser.uid,'friends',targetUid), {
    uid: targetUid, name: target.name || target.email || 'Без имени', note:'', online: !!target.online,
    friendCode: target.friendCode || code
  }, {merge:true});

  await setDoc(doc(db,'users',targetUid,'friends',auth.currentUser.uid), {
    uid: auth.currentUser.uid, name: me.name || me.email || 'Без имени', note:'', online:true,
    friendCode: me.friendCode || $('#meUid').textContent.trim()
  }, {merge:true});

  $('#addfriend').classList.remove('show');
  loadFriends();
};

/* friend menu */
let fmCurrent=null;
function openFriendMenu(uid, name, note){
  fmCurrent = uid;
  $('#fm-name').textContent = name;
  $('#fm-note').value = note || '';
  $('#friend-menu').classList.add('show');
}
$('#fm-close').onclick = ()=> { $('#friend-menu').classList.remove('show'); fmCurrent=null; };
$('#fm-save').onclick = async ()=>{
  if(!fmCurrent) return;
  await updateDoc(doc(db,'users',auth.currentUser.uid,'friends',fmCurrent), { note: $('#fm-note').value.trim() });
  $('#friend-menu').classList.remove('show'); fmCurrent=null; loadFriends();
};
$('#fm-delete').onclick = async ()=>{
  if(!fmCurrent) return;
  await deleteDoc(doc(db,'users',auth.currentUser.uid,'friends',fmCurrent));
  try{ await deleteDoc(doc(db,'users',fmCurrent,'friends',auth.currentUser.uid)); }catch(e){}
  $('#friend-menu').classList.remove('show'); fmCurrent=null; loadFriends();
};
/* peer menu (in-call) */
let pmCurrent=null;
function openPeerMenu(uid){
  pmCurrent = uid;
  $('#pm-name').textContent = (peerNames.get(uid) || 'Собеседник');
  const s = sinks.get(uid);
  const v = s && s.gain ? Math.round(Math.max(0, Math.min(2, s.gain.gain.value))*100) : 100;
  const el = $('#pm-volume'); if(el) el.value = String(v);
  $('#peer-menu').classList.add('show');
}
$('#pm-close').onclick = ()=>{ $('#peer-menu').classList.remove('show'); pmCurrent=null; };
$('#pm-volume').oninput = (e)=>{
  const val = Math.max(0, Math.min(200, parseInt((e?.target?.value)||'100',10)))/100;
  if(pmCurrent && sinks.get(pmCurrent)?.gain) sinks.get(pmCurrent).gain.gain.value = val;
};

/* ===== звонки ===== */
let myStream=null, audioCtx=null, micTrack=null, micOn=true;
let callId=null, callStartedAt=null, timerId=null;
const pcs = new Map();            // peerUid -> RTCPeerConnection
const senders = new Map();        // peerUid -> RTCRtpSender
const sinks = new Map();          // uid -> {audioEl, gainNode, analyser}
const members = new Set();        // участники
const joinedAt = new Map();
let unsubMembers=null;            // отписка от members
let waitTargetUnsub=null;         // ожидание принятия
let createdCallRef=null;          // ref calls/{id}
let createdInviteRef=null;        // ref users/{target}/invites/{id}

// additional state
let waitInviteUnsub=null;         // unsubscribe for target invite status
const peerNames = new Map();      // uid -> display name

function startTimer(){ callStartedAt=Date.now(); clearInterval(timerId); timerId=setInterval(()=> $('#timer').textContent = sec2hms((Date.now()-callStartedAt)/1000), 1000); }
function stopTimer(){ clearInterval(timerId); $('#timer').textContent='0:00:00'; }

async function ensureMicTrack(){
  if(!myStream || !micTrack || micTrack.readyState==='ended'){
    myStream = await navigator.mediaDevices.getUserMedia({ audio:true, video:false });
    micTrack = myStream.getAudioTracks()[0];
    micTrack.onended = ()=>{ /* на всяк. случай пересоздадим при следующем включении */ };
  }
}
async function ensureMedia(){
  await ensureMicTrack();
  if(!audioCtx){ audioCtx = new (window.AudioContext||window.webkitAudioContext)(); }
  micOn = true; setMicUI();
}
function setMicUI(){
  $('#btn-mic').classList.toggle('on', micOn);
  $('#btn-mic').classList.toggle('off', !micOn);
}

/* Исходящий звонок: сначала "Звоним ..." с кнопкой Отменить. В комнату — только после принятия.*/
async function placeCall(targetUid, targetName){
  // создаём комнату
  createdCallRef = await addDoc(collection(db,'calls'), {
    createdBy: auth.currentUser.uid, startedAt: serverTimestamp(), active:true,
    invited: [targetUid]   // чтобы аннулировать у друга при отмене (можно в правилах разрешить read invited)
  });

  // показываем модалку "Звоним ..."
  $('#calling-title').textContent = `Звоним: ${targetName||'друг'}`;
  $('#calling').classList.add('show');

  // ждём, когда друг добавит себя в members
  const targetMemberRef = doc(db,'calls',createdCallRef.id,'members',targetUid);
  waitTargetUnsub = onSnapshot(targetMemberRef, async (s)=>{
    if(s.exists()){
      // принял — входим
      $('#calling').classList.remove('show');
      callId = createdCallRef.id;
      waitTargetUnsub?.(); waitTargetUnsub=null;
      await ensureMedia();
      await setDoc(doc(db,'calls',callId,'members',auth.currentUser.uid), {
        uid: auth.currentUser.uid, name: $('#meBadge').textContent || 'Me', joinedAt: serverTimestamp()
      });
      enterCallUI(callId);
    }
  });

  // отправляем инвайт (с именем)
  createdInviteRef = await addDoc(collection(db,'users',targetUid,'invites'), {
    type:'call', callId: createdCallRef.id, from: auth.currentUser.uid,
    fromName: $('#meBadge').textContent || 'Друг', t: serverTimestamp(), status:'pending'
  });

  // обработчик отмены
  $('#calling-cancel').onclick = async ()=>{
    try{ if(createdInviteRef) await updateDoc(createdInviteRef, { status:'canceled' }); }catch(e){}
    try{ if(createdCallRef) await deleteDoc(createdCallRef); }catch(e){}
    waitTargetUnsub?.(); waitTargetUnsub=null;
    waitInviteUnsub?.(); waitInviteUnsub=null;
    $('#calling').classList.remove('show');
    createdCallRef=null; createdInviteRef=null;
  };

    // Auto-close dialing if callee declines or invite is removed
  try{
    waitInviteUnsub = onSnapshot(createdInviteRef, (snap)=>{
      const inv = snap.exists() ? snap.data() : null;
      if(!snap.exists() || (inv && inv.status === 'declined')){
        $('#calling').classList.remove('show');
        try{ if(createdCallRef) deleteDoc(createdCallRef); }catch(e){}
        waitTargetUnsub?.(); waitTargetUnsub=null;
        waitInviteUnsub?.(); waitInviteUnsub=null;
        createdCallRef=null; createdInviteRef=null;
      }
    });
  }catch(e){}
}

/* входящий */
function listenIncoming(){
  const invCol = collection(db,'users',auth.currentUser.uid,'invites');
  onSnapshot(invCol, (snap)=>{
    snap.docChanges().forEach(ch => {
      const id = ch.doc.id;
      const inv = ch.doc.data();
      // скрыть, если отменили/удалили
      if((ch.type==='modified' && inv.status==='canceled') || ch.type==='removed'){
        $('#incoming').classList.remove('show'); return;
      }
      if(ch.type!=='added' || inv.status!=='pending' || !inv.callId) return;

      $('#inc-from').textContent = 'От: ' + (inv.fromName || 'друг');
      $('#incoming').classList.add('show');

      $('#inc-accept').onclick = async ()=>{
        $('#incoming').classList.remove('show');
        callId = inv.callId;
        await setDoc(doc(db,'users',auth.currentUser.uid,'invites', id), {status:'accepted'}, {merge:true});
        await ensureMedia();
        await setDoc(doc(db,'calls',callId,'members',auth.currentUser.uid), {
          uid: auth.currentUser.uid, name: $('#meBadge').textContent || 'Me', joinedAt: serverTimestamp()
        });
        enterCallUI(callId);
      };
      $('#inc-decline').onclick = async ()=>{
        $('#incoming').classList.remove('show');
        await setDoc(doc(db,'users',auth.currentUser.uid,'invites', id), {status:'declined'}, {merge:true});
      };
    });
  });
}

/* вход в UI звонка */
async function enterCallUI(id){
  show('#screen-call');
  setMicUI();
  startTimer();
  renderPeersBar(true);

  if(unsubMembers) try{unsubMembers();}catch{}
  unsubMembers = onSnapshot(collection(db,'calls',id,'members'), (snap)=>{
    members.clear();
    snap.forEach(d=>members.add(d.id));
    snap.docChanges().forEach(ch=>{
      const d=ch.doc.data();
      if(ch.type==='added'){
        joinedAt.set(d.uid, Date.now());
        peerNames.set(d.uid, d.name || '');
        if(d.uid!==auth.currentUser.uid){
          addPeerAvatar(d.uid, d.name);
          connectToPeer(d.uid);
        }
      }
      if(ch.type==='removed'){ removePeer(ch.doc.id); }
    });

    // если в комнате остался один — выходим у всех
    if(members.size<=1){
      setTimeout(()=>{ if(members.size<=1) leaveCallUI(false); }, 300);
    }
  });

  $('#btn-invite').onclick = openInviteModal;
  $('#btn-end').onclick = async ()=> { await leaveCallUI(true); };
  $('#btn-mic').onclick = toggleMic;
}

function renderPeersBar(initial=false){
  const c=$('#peers'); if(initial) c.innerHTML='';
}
function addPeerAvatar(uid, name){
  if(document.getElementById('peer_'+uid)) return;
  const el=document.createElement('div');
  el.onclick = ()=> openPeerMenu(uid);
  el.className='peer'; el.id='peer_'+uid;
  el.innerHTML=`<div class="vad" id="vad_${uid}"></div>${initials(name)}`;
  $('#peers').appendChild(el);
}
function removePeer(uid){
  pcs.get(uid)?.close(); pcs.delete(uid);
  senders.delete(uid);
  sinks.delete(uid);
  const el = document.getElementById('peer_'+uid); if(el) el.remove();
}

/* Приглашение друзей в активный звонок */
async function openInviteModal(){
  const box = $('#invite-container'); box.innerHTML='';
  const inCall = new Set(members);
  const fs = await getDocs(collection(db,'users',auth.currentUser.uid,'friends'));
  let any=false;
  fs.forEach(s=>{
    const fr=s.data();
    if(inCall.has(fr.uid)) return;
    any=true;
    const row=document.createElement('div');
    row.className='friend';
    row.innerHTML = `
      <div class="who">
        <div class="ava"><span>${initials(fr.name||'')}</span></div>
        <div class="titleline"><b>${fr.name||'Без имени'}</b><div class="note">${fr.friendCode||''}</div></div>
      </div>
      <div class="row"><button class="btn primary">Пригласить</button></div>`;
    row.querySelector('.btn').onclick = async ()=>{
      await addDoc(collection(db,'users',fr.uid,'invites'), {
        type:'call', callId, from:auth.currentUser.uid, fromName:$('#meBadge').textContent||'Друг',
        t:serverTimestamp(), status:'pending'
      });
    };
    box.appendChild(row);
  });
  if(!any) box.innerHTML='<div class="note" style="text-align:center">Все друзья уже в комнате или список пуст</div>';
  $('#invite-list').classList.add('show');
}
$('#invite-close').onclick = ()=> $('#invite-list').classList.remove('show');

/* ——— WebRTC ——— */
function pairId(a,b){ return [a,b].sort().join('_'); }
/* ИЗМЕНЕНО: укреплённая конфигурация P2P без TURN */
function pcConfig(){
  return {
    iceServers: [
      { urls: 'stun:stun.l.google.com:19302' }
    ],
    iceCandidatePoolSize: 2,
    bundlePolicy: 'max-bundle',
    rtcpMuxPolicy: 'require'
  };
}

/* ДОБАВЛЕНО: helpers для ICE-рестарта и вотчдогов */
async function restartPairOffer(pc, pairRef, iAmA){
  try { pc.restartIce?.(); } catch {}
  if (!iAmA) return;
  try {
    const offer = await pc.createOffer({ iceRestart: true, offerToReceiveAudio: true });
    await pc.setLocalDescription(offer);
    await updateDoc(pairRef, {
      offerBy: auth.currentUser.uid,
      offer: { type: offer.type, sdp: offer.sdp },
      answer: deleteField(),
      answerBy: deleteField()
    });
  } catch (e) {}
}
function setupIceWatchers(peerUid, pc, pairRef, iAmA){
  let restarting = false;
  let disconnectTimer = null;
  let firstConnectTimer = setTimeout(() => {
    if (pc.iceConnectionState !== 'connected' && pc.iceConnectionState !== 'completed') {
      if (!restarting) { restarting = true; restartPairOffer(pc, pairRef, iAmA).finally(()=>restarting=false); }
    }
  }, 12000);

  pc.oniceconnectionstatechange = () => {
    const s = pc.iceConnectionState;
    if (s === 'connected' || s === 'completed') {
      clearTimeout(disconnectTimer);
      clearTimeout(firstConnectTimer);
    }
    if (s === 'disconnected') {
      clearTimeout(disconnectTimer);
      disconnectTimer = setTimeout(() => {
        if (!restarting) { restarting = true; restartPairOffer(pc, pairRef, iAmA).finally(()=>restarting=false); }
      }, 4000);
    }
    if (s === 'failed') {
      if (!restarting) { restarting = true; restartPairOffer(pc, pairRef, iAmA).finally(()=>restarting=false); }
    }
  };

  pc.onconnectionstatechange = () => {
    if (pc.connectionState === 'failed') {
      if (!restarting) { restarting = true; restartPairOffer(pc, pairRef, iAmA).finally(()=>restarting=false); }
    }
  };
}

async function connectToPeer(peerUid){
  const id = pairId(auth.currentUser.uid, peerUid);
  const pairRef = doc(db,'calls',callId,'pairs',id);
  const iAmA = auth.currentUser.uid < peerUid;

  const pc = new RTCPeerConnection(pcConfig());
  pcs.set(peerUid, pc);

  /* ДОБАВЛЕНО: наблюдатели и авто-рестарты ICE */
  setupIceWatchers(peerUid, pc, pairRef, iAmA);

  await ensureMicTrack();
  const sender = pc.addTrack(micTrack, myStream);

  /* ДОБАВЛЕНО: умеренный битрейт для Opus — стабильнее на слабых сетях */
  try {
    const p = sender.getParameters();
    if (!p.encodings || !p.encodings.length) p.encodings = [{}];
    p.encodings[0].maxBitrate = 24000; // ~24 кбит/с на речь
    await sender.setParameters(p);
  } catch {}

  senders.set(peerUid, sender);

  // remote audio + адаптивный VAD
  pc.ontrack = (ev)=>{
    const stream = ev.streams[0];
    if(!sinks.get(peerUid)){
      const audio = document.createElement('audio'); audio.autoplay=true; audio.srcObject=stream;
      $('#audio-sinks').appendChild(audio);

      if(!audioCtx){ audioCtx = new (window.AudioContext||window.webkitAudioContext)(); }
      const src = audioCtx.createMediaStreamSource(stream);
      const g   = audioCtx.createGain(); g.gain.value = 1.0;
      const an  = audioCtx.createAnalyser(); an.fftSize = 1024; an.smoothingTimeConstant=0.9;
      src.connect(g).connect(audioCtx.destination); src.connect(an);
      sinks.set(peerUid, {audioEl:audio, gain:g, analyser:an});

      const vadEl = document.getElementById('vad_'+peerUid);
      const buf = new Uint8Array(an.fftSize);
      let levelAvg = 0.0, noise=0.008;
      const loop = ()=>{
        if(!sinks.has(peerUid)) return;
        an.getByteTimeDomainData(buf);
        let sum=0; for(let i=0;i<buf.length;i++){ const v=(buf[i]-128)/128; sum+=v*v; }
        const rms = Math.sqrt(sum/buf.length);
        levelAvg = levelAvg*0.85 + rms*0.15;
        noise = Math.min(noise*0.995 + rms*0.005, 0.06);
        const th = Math.max(noise*2.8, 0.012);
        vadEl.classList.toggle('on', levelAvg > th);
        requestAnimationFrame(loop);
      };
      loop();
    }
  };

  // ICE
  pc.onicecandidate = async (e)=>{
    if(!e.candidate) return;
    const sub = collection(db,'calls',callId,'pairs',id, iAmA ? 'ice_a' : 'ice_b');
    await addDoc(sub, JSON.parse(JSON.stringify(e.candidate)));
  };

  // SDP (храним только {type,sdp})
  onSnapshot(pairRef, async (snap)=>{
    const data = snap.data(); if(!data) return;

    if(!pc.currentRemoteDescription && data.offer && data.offerBy !== auth.currentUser.uid){
      await pc.setRemoteDescription(data.offer);
      const answer = await pc.createAnswer();
      await pc.setLocalDescription(answer);
      await updateDoc(pairRef,{ answerBy:auth.currentUser.uid, answer: {type:answer.type, sdp:answer.sdp} });
    }

    if(!pc.currentRemoteDescription &&
       data.answer &&
       data.answerBy !== auth.currentUser.uid &&
       pc.signalingState==='have-local-offer'){
      await pc.setRemoteDescription(data.answer);
    }
  });

  // ICE listeners
  const iceA = collection(db,'calls',callId,'pairs',id,'ice_a');
  const iceB = collection(db,'calls',callId,'pairs',id,'ice_b');
  onSnapshot(iAmA?iceB:iceA, (snap)=> snap.docChanges().forEach(async ch=>{
    if(ch.type!=='added') return;
    try{ await pc.addIceCandidate(ch.doc.data()); }catch{}
  }));

  // создаём offer только одной стороной
  if(iAmA){
    const offer = await pc.createOffer({ offerToReceiveAudio:true });
    await pc.setLocalDescription(offer);
    await setDoc(pairRef, { a:auth.currentUser.uid, b:peerUid, offerBy:auth.currentUser.uid, offer: {type:offer.type, sdp:offer.sdp} }, {merge:true});
  }
}

/* mute/unmute устойчиво — без замены трека на null, сохраняем RTP keepalive */
async function toggleMic(){
  await ensureMicTrack();
  micOn = !micOn;
  if (micTrack) micTrack.enabled = micOn;
  setMicUI();
}

/* выход из звонка */
async function cleanupMyPairs(){
  if (!callId) return;
  try{
    const pairsSnap = await getDocs(collection(db,'calls',callId,'pairs'));
    const me = auth.currentUser.uid;
    for (const d of pairsSnap.docs) {
      const data = d.data() || {};
      if (data.a === me || data.b === me) {
        await deleteDoc(doc(db,'calls',callId,'pairs', d.id));
      }
    }
  }catch{}
}

async function leaveCallUI(removeMyMember=false){
  try{
    if(removeMyMember && callId){
      await deleteDoc(doc(db,'calls',callId,'members',auth.currentUser.uid));
    }
  }catch{}
  try{ if(unsubMembers) unsubMembers(); }catch{}
  members.clear();
  pcs.forEach(pc=>pc.close()); pcs.clear();
  senders.clear(); sinks.clear();
  stopTimer();
  await cleanupMyPairs(); /* ДОБАВЛЕНО: подчистка своих пар сигналинга */
  show('#screen-friends');
  callId=null;
}
</script>
</body>
</html>
