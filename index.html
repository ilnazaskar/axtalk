<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>AxTalk</title>
<meta name="theme-color" content="#0c0f14" />
<style>
:root{
  --bg:#0c0f14;
  --bg-2:#0f131a;
  --outline:#1c2230;
  --text:#e8ecf8;
  --text-dim:#9aa7c8;
  --green:#1bd35f;
  --red:#ff3b30;
  --gray:#30384a;
  --ring:0 0 0 3px #2c5bff33;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
.app{min-height:100svh;display:grid}
.shell{max-width:520px;margin:auto;min-height:100svh;height:100%;display:grid;background:var(--bg);}
.screen{display:none} .screen.active{display:block}

/* generic */
.pad{padding:18px}
.stack{display:flex;flex-direction:column;gap:12px}
.row{display:flex;gap:10px;align-items:center}
.btn{
  all:unset;cursor:pointer;border:1px solid var(--outline);border-radius:14px;
  background:var(--bg-2);padding:12px 14px;display:flex;justify-content:center;align-items:center
}
.btn.primary{background:#27406f;color:#fff;border-color:#27406f}
.btn:focus-visible{box-shadow:var(--ring)}
.card{border:1px solid var(--outline);border-radius:16px;background:var(--bg-2);padding:14px}
.hr{height:1px;background:var(--outline);margin:8px 0}
.note{color:var(--text-dim);font-size:12.5px;text-align:center}

/* auth screen */
.hero{display:grid;gap:16px;padding:28px}
.hero .title{font-size:22px;font-weight:700}
.google{display:flex;gap:10px;align-items:center;justify-content:center}
.google svg{background:#fff;border-radius:50%;display:block}

/* friends screen */
.friend{display:flex;align-items:center;justify-content:space-between;padding:10px;border-radius:12px;border:1px solid var(--outline)}
.who{display:flex;gap:12px;align-items:center}
.ava{width:36px;height:36px;border-radius:50%;display:grid;place-items:center;background:#1b2130;border:1px solid var(--outline);position:relative}
.dot{position:absolute;right:-2px;bottom:-2px;width:10px;height:10px;border-radius:99px;background:#586174;border:1px solid var(--bg-2)}
.dot.on{background:#1bd35f}

/* incoming modal (calls) */
.modal{position:fixed;inset:0;background:#0008;display:none;place-items:center;padding:18px}
.modal.show{display:grid}
.sheet{width:100%;max-width:420px;background:var(--bg-2);border:1px solid var(--outline);border-radius:18px;padding:18px;display:grid;gap:12px;justify-items:center}
.sheet .bigava{width:64px;height:64px;border-radius:50%;display:grid;place-items:center;background:#1b2130;border:1px solid var(--outline)}
.sheet .name{font-size:18px;font-weight:700}
.actions{display:flex;gap:12px}
.act{all:unset;cursor:pointer;width:64px;height:64px;border-radius:50%;display:grid;place-items:center;color:#fff}
.act.accept{background:var(--green)} .act.decline{background:var(--red)}

/* call screen */
.call{min-height:100svh;display:grid;grid-template-rows:auto 1fr auto}
.topbar{display:flex;align-items:center;justify-content:space-between;padding:10px 14px;border-bottom:1px solid var(--outline)}
.badge{border:1px dashed var(--outline);border-radius:12px;padding:6px 10px;color:var(--text-dim)}
.invite-btn{all:unset;border:1px solid var(--outline);border-radius:12px;padding:8px 12px;cursor:pointer}

.peers{display:flex;gap:10px;align-items:center;overflow:auto;padding:10px 14px;border-bottom:1px solid var(--outline)}
.peer{
  position:relative;min-width:44px;width:44px;height:44px;border-radius:50%;display:grid;place-items:center;
  background:#1b2130;border:2px solid #1b2130; color:#fff;cursor:pointer;user-select:none
}
.peer.talking{box-shadow:0 0 0 3px #1bd35f55;border-color:#1bd35f}
.peer .vad{position:absolute;inset:-3px;border-radius:50%;border:3px solid transparent;pointer-events:none}
.peer .vad.on{border-color:#1bd35f}

.center{display:grid;place-items:center;padding:18px}
.timer{font-size: clamp(36px, 9vw, 56px);font-weight:700;letter-spacing:.5px}

.controls{display:flex;gap:22px;justify-content:center;align-items:center;padding:16px;border-top:1px solid var(--outline)}
.fab{all:unset;width:68px;height:68px;border-radius:50%;display:grid;place-items:center;color:#fff;cursor:pointer;box-shadow:0 8px 22px #0006;border:1px solid #0000}
.fab.mic.on{background:var(--green)}      /* зелёный если включен */
.fab.mic.off{background:#3a4354}         /* серый если выключен */
.fab.end{background:var(--red)}

.smallmenu{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);min-width:260px;background:var(--bg-2);border:1px solid var(--outline);border-radius:14px;padding:14px;display:none}
.smallmenu.show{display:block}
.smallmenu .row{justify-content:space-between}
.range{width:160px}
.hidden{display:none!important}
audio{display:none}

/* simple input */
input[type="text"]{color:var(--text)}
</style>
</head>
<body>
<div class="app">
  <div class="shell" id="app">

    <!-- AUTH -->
    <section class="screen active" id="screen-auth">
      <div class="hero">
        <div class="title">AxTalk</div>
        <button id="btn-google" class="btn primary google">
          <svg width="18" height="18" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.303C33.245,32.091,29.065,35,24,35c-6.075,0-11-4.925-11-11 s4.925-11,11-11c2.803,0,5.367,1.059,7.314,2.786l5.657-5.657C33.555,6.053,28.973,4,24,4C12.955,4,4,12.955,4,24 s8.955,20,20,20s20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"/><path fill="#FF3D00" d="M6.306,14.691l6.571,4.819C14.655,16.108,18.961,13,24,13c2.803,0,5.367,1.059,7.314,2.786l5.657-5.657 C33.555,6.053,28.973,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"/><path fill="#4CAF50" d="M24,44c4.942,0,9.448-1.897,12.837-4.993l-5.926-5.018C29.006,35.091,26.668,36,24,36 c-5.041,0-9.21-2.899-11.281-7.074l-6.522,5.025C9.505,39.556,16.227,44,24,44z"/><path fill="#1976D2" d="M43.611,20.083H42V20H24v8h11.303c-1.018,2.908-3.168,5.266-5.89,6.724 c0.001-0.001,0.002-0.001,0.003-0.002l5.926,5.018C34.971,40.149,44,34,44,24C44,22.659,43.862,21.35,43.611,20.083z"/></svg>
          Войти через Google
        </button>
      </div>
    </section>

    <!-- FRIENDS -->
    <section class="screen" id="screen-friends">
      <div class="pad stack">

        <div class="row" style="justify-content:space-between">
          <div id="meBadge" class="badge">…</div>
          <button id="btn-signout" class="btn">Выйти</button>
        </div>

        <!-- Профиль: ник + UID + копирование -->
        <div class="card" id="profile-card">
          <div class="stack">
            <div class="row" style="justify-content:space-between;align-items:flex-end">
              <div style="display:flex;flex-direction:column;gap:6px;flex:1">
                <label for="meName" class="note" style="text-align:left">Ваш ник</label>
                <input id="meName" type="text" placeholder="Введите ник" style="all:unset;background:var(--bg-2);border:1px solid var(--outline);padding:10px 12px;border-radius:12px"/>
              </div>
              <button id="btn-save-name" class="btn" style="margin-left:10px">Сохранить</button>
            </div>
            <div class="row" style="justify-content:space-between">
              <div class="note" style="text-align:left">Ваш ID: <code id="meUid">...</code></div>
              <button id="btn-copy-uid" class="btn" title="Скопировать ID">Копировать</button>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="row" style="justify-content:space-between"><b>Друзья</b><button id="btn-add-friend" class="btn">Добавить друга</button></div>
          <div id="friends" class="stack"></div>
        </div>

      </div>
    </section>

    <!-- CALL -->
    <section class="screen" id="screen-call">
      <div class="call">
        <div class="topbar">
          <div id="callTitle" class="badge">Звонок</div>
          <button id="btn-invite" class="invite-btn">Пригласить друга</button>
        </div>
        <div class="peers" id="peers"></div>
        <div class="center"><div id="timer" class="timer">0:00:00</div></div>
        <div class="controls">
          <button id="btn-mic" class="fab mic on" title="Микрофон">
            <svg width="30" height="30" viewBox="0 0 24 24" fill="none"><path d="M12 14a3 3 0 0 0 3-3V6a3 3 0 1 0-6 0v5a3 3 0 0 0 3 3Zm7-3a1 1 0 1 1 2 0 9 9 0 0 1-8 8.94V22a1 1 0 0 1-2 0v-2.06A9 9 0 0 1 5 11a1 1 0 1 1 2 0 7 7 0 1 0 14 0Z" fill="currentColor"/></svg>
          </button>
          <button id="btn-end" class="fab end" title="Завершить">
            <svg width="30" height="30" viewBox="0 0 24 24" fill="currentColor"><path d="M12 8c2.76 0 5.26 1.12 7.07 2.93l.93.93a1 1 0 0 1 0 1.41l-2 2a1 1 0 0 1-1.41 0l-1.06-1.06a1 1 0 0 0-1.1-.22 7.6 7.6 0 0 1-4.86 0 1 1 0 0 0-1.1.22L7.41 15.3a1 1 0 0 1-1.41 0l-2-2a1 1 0 0 1 0-1.41l.93-.93A11 11 0 0 1 12 8Z"/></svg>
          </button>
        </div>
      </div>
    </section>

    <!-- Incoming call modal -->
    <div id="incoming" class="modal">
      <div class="sheet">
        <div class="bigava" id="inc-ava">?</div>
        <div class="name" id="inc-name">Звонок…</div>
        <div class="actions">
          <button id="inc-accept" class="act accept" title="Принять">✔</button>
          <button id="inc-decline" class="act decline" title="Отклонить">✕</button>
        </div>
      </div>
    </div>

    <!-- Peer mini-menu (in-call) -->
    <div id="peer-menu" class="smallmenu">
      <div class="row"><div id="pm-name">Имя</div><div id="pm-time">0:00</div></div>
      <div class="hr"></div>
      <div class="row"><span>Громкость</span><input id="pm-volume" class="range" type="range" min="0" max="1" step="0.01" /></div>
      <div class="row" style="justify-content:flex-end"><button id="pm-close" class="btn">Закрыть</button></div>
    </div>

    <!-- Add Friend modal -->
    <div id="addfriend" class="modal">
      <div class="sheet" style="width:100%;max-width:420px;gap:10px">
        <div style="font-weight:700">Добавить друга</div>
        <div class="note">Вставьте уникальный ID друга</div>
        <input id="af-id" type="text" placeholder="ID друга (UID)" style="all:unset;background:var(--bg-2);border:1px solid var(--outline);padding:10px 12px;border-radius:12px;width:100%"/>
        <div class="actions">
          <button id="af-add" class="act accept" title="Добавить">+</button>
          <button id="af-cancel" class="act decline" title="Отмена">✕</button>
        </div>
      </div>
    </div>

    <!-- Friend menu (note & delete) -->
    <div id="friend-menu" class="smallmenu">
      <div class="row" style="justify-content:space-between"><b id="fm-name">Ник</b><button id="fm-close" class="btn">✕</button></div>
      <div class="hr"></div>
      <div class="row" style="justify-content:space-between">
        <span class="note">Пометка</span>
        <input id="fm-note" class="range" type="text" placeholder="например: Никита" style="width:180px"/>
      </div>
      <div class="row" style="justify-content:flex-end;gap:8px">
        <button id="fm-save" class="btn primary">Сохранить</button>
        <button id="fm-delete" class="btn" style="border-color:var(--red);color:#fff;background:#2a1111">Удалить из друзей</button>
      </div>
    </div>

    <!-- hidden audio sinks -->
    <div id="audio-sinks"></div>
  </div>
</div>

<!-- Firebase SDK (modular) -->
<script type="module">
/* ===== Firebase bootstrap ===== */
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js';
import {
  getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut
} from 'https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js';
import {
  getFirestore, doc, setDoc, getDoc, addDoc, getDocs, updateDoc, deleteDoc,
  collection, serverTimestamp, onSnapshot, query, where, orderBy, limit
} from 'https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js';

const firebaseConfig = {
  apiKey: "AIzaSyCezq2wfC4p2ucVz5wzreoaxBTzvHjkwzg",
  authDomain: "call-19b9a.firebaseapp.com",
  projectId: "call-19b9a",
  storageBucket: "call-19b9a.firebasestorage.app",
  messagingSenderId: "264482012809",
  appId: "1:264482012809:web:d0a30eabbd3184944a5058",
  measurementId: "G-TDP7N49324"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db   = getFirestore(app);

/* ===== UI helpers ===== */
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
const show = id => { $$('.screen').forEach(x=>x.classList.remove('active')); $(id).classList.add('active'); };
function initials(name){ return (name||'?').trim().slice(0,1).toUpperCase(); }
function sec2hms(sec){ const h=Math.floor(sec/3600); const m=Math.floor((sec%3600)/60); const s=Math.floor(sec%60); return `${h}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`; }

/* ===== Presence (simple ping) ===== */
let presTimer=null;
async function setPresence(user){
  const uref=doc(db,'users',user.uid);
  await setDoc(uref,{ uid:user.uid, name:user.displayName||'Без имени', email:user.email||null, lastActive:serverTimestamp(), online:true }, {merge:true});
  clearInterval(presTimer);
  presTimer=setInterval(()=> updateDoc(uref,{ lastActive:serverTimestamp(), online:true }).catch(()=>{}), 20000);
}

/* ===== Auth UI ===== */
$('#btn-google').onclick = async ()=>{ await signInWithPopup(auth, new GoogleAuthProvider()); };
$('#btn-signout').onclick = ()=> signOut(auth);

onAuthStateChanged(auth, async (user)=>{
  if(!user){ show('#screen-auth'); return; }
  await setPresence(user);
  $('#meBadge').textContent = user.displayName || user.email || user.uid;
  await loadProfile();
  await loadFriends();
  listenIncoming(); // звонки
  show('#screen-friends');
});

/* ===== Friends ===== */
async function loadFriends(){
  const list=$('#friends'); list.innerHTML='';
  const fs = await getDocs(collection(db,'users',auth.currentUser.uid,'friends'));
  if(fs.empty){ list.innerHTML = '<div class="note">Список пуст. Нажмите «Добавить друга».</div>'; return; }
  fs.forEach(snap=>{
    const fr = snap.data();
    const el=document.createElement('div');
    el.className='friend';
    const friendLabel = `${fr.name || 'Без имени'}${fr.note ? ' ~ ' + fr.note : ''}`;
    el.innerHTML=`
      <div class="who">
        <div class="ava"><span>${initials(fr.name||'')}</span><span class="dot ${fr.online?'on':''}"></span></div>
        <div>
          <div><b>${friendLabel}</b></div>
          <div class="note">ID: ${fr.uid}</div>
        </div>
      </div>
      <div class="row">
        <button class="btn primary" data-call="${fr.uid}" title="Позвонить">Позвонить</button>
        <button class="btn" data-edit="${fr.uid}" title="Редактировать пометку">✎</button>
      </div>
    `;
    el.querySelector('[data-call]').onclick = ()=> startCallWith(fr.uid);
    el.querySelector('[data-edit]').onclick = ()=> openFriendMenu(fr.uid, fr.name||'Без имени', fr.note||'');
    list.appendChild(el);
  });
}

/* кнопка "Добавить друга" -> модалка */
$('#btn-add-friend').onclick = ()=>{
  $('#af-id').value='';
  $('#addfriend').classList.add('show');
};
$('#af-cancel').onclick = ()=> $('#addfriend').classList.remove('show');
$('#af-add').onclick = async ()=>{
  const fid = $('#af-id').value.trim();
  if(!fid) return;
  if(fid === auth.currentUser.uid) { alert('Нельзя добавить себя'); return; }

  const fProfileRef = doc(db,'users',fid);
  const fSnap = await getDoc(fProfileRef);
  if(!fSnap.exists()){ alert('Пользователь с таким ID не найден'); return; }
  const fData = fSnap.data();

  const mySnap = await getDoc(doc(db,'users',auth.currentUser.uid));
  const myData = mySnap.data()||{};

  // записать у себя
  await setDoc(doc(db,'users',auth.currentUser.uid,'friends',fid), {
    uid: fid, name: fData.name || fData.email || 'Без имени', note:'', online: !!fData.online
  }, {merge:true});

  // попытаться записать у друга (взаимно)
  try{
    await setDoc(doc(db,'users',fid,'friends',auth.currentUser.uid), {
      uid: auth.currentUser.uid, name: myData.name || myData.email || 'Без имени', note:'', online:true
    }, {merge:true});
  }catch(e){
    console.warn('Mutual add failed (rules?):', e);
    // запасной вариант — заявка в друзья
    try{
      await addDoc(collection(db,'users',fid,'invites'), { type:'friend', from: auth.currentUser.uid, name: myData.name||null, t: serverTimestamp(), status:'pending' });
      alert('Запрос дружбы отправлен. У друга появится приглашение.');
    }catch(_){}
  }

  $('#addfriend').classList.remove('show');
  loadFriends();
};

/* меню друга — пометка / удаление */
let fmCurrent=null;
function openFriendMenu(uid, name, note){
  fmCurrent = uid;
  $('#fm-name').textContent = name;
  $('#fm-note').value = note || '';
  $('#friend-menu').classList.add('show');
}
$('#fm-close').onclick = ()=> { $('#friend-menu').classList.remove('show'); fmCurrent=null; };
$('#fm-save').onclick = async ()=>{
  if(!fmCurrent) return;
  await updateDoc(doc(db,'users',auth.currentUser.uid,'friends',fmCurrent), { note: $('#fm-note').value.trim() });
  $('#friend-menu').classList.remove('show'); fmCurrent=null; loadFriends();
};
$('#fm-delete').onclick = async ()=>{
  if(!fmCurrent) return;
  if(!confirm('Удалить из друзей?')) return;
  await deleteDoc(doc(db,'users',auth.currentUser.uid,'friends',fmCurrent));
  try{ await deleteDoc(doc(db,'users',fmCurrent,'friends',auth.currentUser.uid)); }catch(e){ console.warn('Mutual delete failed (rules?)', e); }
  $('#friend-menu').classList.remove('show'); fmCurrent=null; loadFriends();
};

/* ===== Профиль (ник, UID, копировать) ===== */
async function loadProfile(){
  const uref=doc(db,'users',auth.currentUser.uid);
  const usnap=await getDoc(uref);
  const udata=usnap.data()||{};
  $('#meName').value = udata.name || auth.currentUser.displayName || '';
  $('#meUid').textContent = auth.currentUser.uid;
}
$('#btn-save-name').onclick = async ()=>{
  const name = $('#meName').value.trim() || 'Без имени';
  await setDoc(doc(db,'users',auth.currentUser.uid), { name }, {merge:true});
  $('#meBadge').textContent = name;
  await loadFriends();
};
$('#btn-copy-uid').onclick = async ()=>{
  try{ await navigator.clipboard.writeText(auth.currentUser.uid); $('#btn-copy-uid').textContent='Скопировано'; setTimeout(()=>$('#btn-copy-uid').textContent='Копировать',1200);}catch{}
};

/* ===== Signaling model (calls) =====
calls/{callId}:
  { createdBy, startedAt, active:true }
  members/{uid}: { uid, name, joinedAt }
  pairs/{pairId}: { a, b, offerBy, offer, answerBy, answer }
  pairs/{pairId}/ice_a, ice_b: { sdpMid, sdpMLineIndex, candidate, t }
pairId = [a,b].sort().join('_')
Each participant creates RTCPeerConnection per pair.
*/

let myStream=null, audioCtx=null, micTrack=null;
let callId=null, callStartedAt=null, timerId=null;
const pcs = new Map();           // key: peerUid -> RTCPeerConnection
const sinks = new Map();         // uid -> {audioEl, gainNode, analyser}
const joinedAt = new Map();      // uid -> timestamp

function startTimer(){ callStartedAt=Date.now(); clearInterval(timerId); timerId=setInterval(()=> $('#timer').textContent = sec2hms((Date.now()-callStartedAt)/1000), 1000); }
function stopTimer(){ clearInterval(timerId); $('#timer').textContent='0:00:00'; }

async function ensureMedia(){
  if(myStream) return;
  myStream = await navigator.mediaDevices.getUserMedia({ audio:true, video:false });
  micTrack = myStream.getAudioTracks()[0];
  $('#btn-mic').classList.add('on'); $('#btn-mic').classList.remove('off');
  if(!audioCtx){ audioCtx = new (window.AudioContext||window.webkitAudioContext)(); }
}

async function startCallWith(targetUid){
  const ref = await addDoc(collection(db,'calls'), {
    createdBy: auth.currentUser.uid,
    startedAt: serverTimestamp(),
    active:true
  });
  callId = ref.id;
  await setDoc(doc(db,'calls',callId,'members',auth.currentUser.uid), {
    uid: auth.currentUser.uid, name: auth.currentUser.displayName||$('#meName').value||'Me', joinedAt: serverTimestamp()
  });
  await addDoc(collection(db,'users',targetUid,'invites'), { type:'call', callId, from: auth.currentUser.uid, t: serverTimestamp(), status:'pending' });
  enterCallUI(callId);
}

function listenIncoming(){
  const invCol = collection(db,'users',auth.currentUser.uid,'invites');
  onSnapshot(invCol, (snap)=>{
    snap.docChanges().forEach(ch => {
      const inv = ch.doc.data();
      if(ch.type!=='added' || inv.status!=='pending') return;
      if(!inv.callId) return; // игнорим friend-заявки здесь
      $('#incoming').classList.add('show');
      $('#inc-name').textContent = 'Звонок';
      $('#inc-ava').textContent = '☎';
      $('#inc-accept').onclick = async ()=>{
        $('#incoming').classList.remove('show');
        callId = inv.callId;
        await setDoc(doc(db,'users',auth.currentUser.uid,'invites', ch.doc.id), {status:'accepted'}, {merge:true});
        await setDoc(doc(db,'calls',callId,'members',auth.currentUser.uid), {
          uid: auth.currentUser.uid, name: auth.currentUser.displayName||$('#meName').value||'Me', joinedAt: serverTimestamp()
        });
        enterCallUI(callId);
      };
      $('#inc-decline').onclick = async ()=>{
        $('#incoming').classList.remove('show');
        await setDoc(doc(db,'users',auth.currentUser.uid,'invites', ch.doc.id), {status:'declined'}, {merge:true});
      };
    });
  });
}

async function enterCallUI(id){
  await ensureMedia();
  show('#screen-call');
  $('#callTitle').textContent = `Комната #${id.slice(0,6)}`;
  startTimer();
  renderPeersBar(); // me

  onSnapshot(collection(db,'calls',id,'members'), (snap)=>{
    snap.docChanges().forEach(ch=>{
      const d=ch.doc.data();
      if(ch.type==='added'){ joinedAt.set(d.uid, Date.now()); addPeerAvatar(d.uid, d.name); if(d.uid!==auth.currentUser.uid) connectToPeer(d.uid); }
      if(ch.type==='removed'){ removePeer(d.uid); }
    });
  });

  const myRef = doc(db,'calls',id,'members',auth.currentUser.uid);
  const myDoc = await getDoc(myRef);
  if(!myDoc.exists()) await setDoc(myRef,{ uid:auth.currentUser.uid, name: $('#meName').value||'Me', joinedAt: serverTimestamp() });

  // Приглашение по ID
  $('#btn-invite').onclick = async ()=>{
    const fid = prompt('ID друга для приглашения (UID):');
    if(!fid) return;
    await addDoc(collection(db,'users',fid,'invites'), { type:'call', callId:id, from:auth.currentUser.uid, t:serverTimestamp(), status:'pending' });
    alert('Приглашение отправлено.');
  };

  $('#btn-end').onclick = async ()=>{
    pcs.forEach(pc=>pc.close()); pcs.clear();
    stopTimer();
    show('#screen-friends');
  };

  $('#btn-mic').onclick = ()=>{
    const enabled = micTrack.enabled;
    micTrack.enabled = !enabled;
    $('#btn-mic').classList.toggle('on', micTrack.enabled);
    $('#btn-mic').classList.toggle('off', !micTrack.enabled);
  };
}

function renderPeersBar(){
  const c=$('#peers'); c.innerHTML='';
  addPeerAvatar(auth.currentUser.uid, $('#meName').value || auth.currentUser.displayName || 'Я', true);
}
function addPeerAvatar(uid, name, isMe=false){
  if(document.getElementById('peer_'+uid)) return;
  const el=document.createElement('div');
  el.className='peer'; el.id='peer_'+uid;
  el.innerHTML=`<div class="vad" id="vad_${uid}"></div>${initials(name)}`;
  $('#peers').appendChild(el);
  el.onclick = ()=> openPeerMenu(uid, name);
}
function removePeer(uid){
  pcs.get(uid)?.close(); pcs.delete(uid);
  sinks.delete(uid);
  const el = document.getElementById('peer_'+uid); if(el) el.remove();
}

/* ===== WebRTC per-pair over Firestore ===== */
function pairId(a,b){ return [a,b].sort().join('_'); }
function pcConfig(){ return { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] }; } // STUN

async function connectToPeer(peerUid){
  const id = pairId(auth.currentUser.uid, peerUid);
  const pairRef = doc(db,'calls',callId,'pairs',id);

  const pc = new RTCPeerConnection(pcConfig());
  pcs.set(peerUid, pc);

  // local audio only
  myStream.getTracks().forEach(tr=> pc.addTrack(tr, myStream));

  // remote stream sink + VAD
  pc.ontrack = (ev)=>{
    const stream = ev.streams[0];
    let sink = sinks.get(peerUid);
    if(!sink){
      const audio = document.createElement('audio'); audio.autoplay=true; audio.srcObject=stream;
      const container = $('#audio-sinks'); container.appendChild(audio);
      if(!audioCtx){ audioCtx = new (window.AudioContext||window.webkitAudioContext)(); }
      const g = audioCtx.createGain(); g.gain.value = 1.0;
      const src = audioCtx.createMediaStreamSource(stream);
      const analyser = audioCtx.createAnalyser(); analyser.fftSize = 2048;
      src.connect(g).connect(audioCtx.destination);
      src.connect(analyser);
      sink = {audioEl:audio, gain:g, analyser};
      sinks.set(peerUid, sink);
      // VAD loop
      const vadEl = document.getElementById('vad_'+peerUid);
      const buf = new Uint8Array(analyser.fftSize);
      const loop = ()=>{
        if(!sinks.has(peerUid)) return;
        analyser.getByteTimeDomainData(buf);
        let sum=0; for(let i=0;i<buf.length;i++){ const v=(buf[i]-128)/128; sum+=v*v; }
        const rms = Math.sqrt(sum/buf.length);
        const talking = rms > 0.05;
        vadEl.classList.toggle('on', talking);
        requestAnimationFrame(loop);
      };
      loop();
    }
  };

  // ICE
  pc.onicecandidate = async (e)=>{
    if(!e.candidate) return;
    const sub = collection(db,'calls',callId,'pairs',id, auth.currentUser.uid===peerUid ? 'ice_b' : 'ice_a');
    await addDoc(sub, JSON.parse(JSON.stringify(e.candidate)));
  };

  // Signaling listeners
  onSnapshot(pairRef, async (snap)=>{
    const data=snap.data(); if(!data) return;
    if(!pc.currentRemoteDescription && data.offer && data.offerBy!==auth.currentUser.uid){
      await pc.setRemoteDescription(data.offer);
      const answer = await pc.createAnswer();
      await pc.setLocalDescription(answer);
      await updateDoc(pairRef,{ answerBy:auth.currentUser.uid, answer: pc.localDescription });
    }
    if(!pc.currentRemoteDescription && data.answer && data.answerBy!==auth.currentUser.uid && pc.signalingState==='have-local-offer'){
      await pc.setRemoteDescription(data.answer);
    }
  });

  // ICE listeners
  const iceA = collection(db,'calls',callId,'pairs',id,'ice_a');
  const iceB = collection(db,'calls',callId,'pairs',id,'ice_b');
  onSnapshot(iceA, (snap)=> snap.docChanges().forEach(async ch=>{
    if(ch.type!=='added') return;
    try{ await pc.addIceCandidate(ch.doc.data()); }catch{}
  }));
  onSnapshot(iceB, (snap)=> snap.docChanges().forEach(async ch=>{
    if(ch.type!=='added') return;
    try{ await pc.addIceCandidate(ch.doc.data()); }catch{}
  }));

  // Create offer if I'm lexicographically "caller"
  const myIsCaller = auth.currentUser.uid < peerUid;
  if(myIsCaller){
    const offer = await pc.createOffer({offerToReceiveAudio:true});
    await pc.setLocalDescription(offer);
    await setDoc(pairRef, { a:auth.currentUser.uid, b:peerUid, offerBy:auth.currentUser.uid, offer: pc.localDescription }, {merge:true});
  }
}

/* ===== Mini peer menu (in-call) ===== */
function openPeerMenu(uid, name){
  const m=$('#peer-menu');
  $('#pm-name').textContent = name || 'Пользователь';
  $('#pm-time').textContent = sec2hms(((Date.now()) - (joinedAt.get(uid)||Date.now()))/1000);
  const sink = sinks.get(uid);
  $('#pm-volume').value = sink ? sink.gain.gain.value : 1;
  $('#pm-volume').oninput = (e)=>{ if(sink){ sink.gain.gain.value = Number(e.target.value); } };
  $('#pm-close').onclick = ()=> m.classList.remove('show');
  m.classList.add('show');
}
</script>
</body>
</html>

